<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tsm.system.mapper.PermissionMapper">

    <!-- 权限结果映射 -->
    <resultMap id="BaseResultMap" type="com.tsm.system.entity.Permission">
        <id column="id" property="id" />
        <result column="parent_id" property="parentId" />
        <result column="permission_name" property="permissionName" />
        <result column="permission_code" property="permissionCode" />
        <result column="permission_type" property="permissionType" />
        <result column="menu_url" property="menuUrl" />
        <result column="menu_icon" property="menuIcon" />
        <result column="sort_order" property="sortOrder" />
        <result column="status" property="status" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="create_by" property="createBy" />
        <result column="update_by" property="updateBy" />
        <result column="deleted" property="deleted" />
    </resultMap>

    <!-- 基础字段 -->
    <sql id="Base_Column_List">
        id, parent_id, permission_name, permission_code, permission_type, menu_url, menu_icon, 
        sort_order, status, create_time, update_time, create_by, update_by, deleted
    </sql>

    <!-- 根据权限编码查询权限 -->
    <select id="selectByPermissionCode" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM tsm_permission
        WHERE permission_code = #{permissionCode} AND deleted = 0
    </select>

    <!-- 分页查询权限列表 -->
    <select id="selectPermissionPage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM tsm_permission
        WHERE deleted = 0
        <if test="permissionName != null and permissionName != ''">
            AND permission_name LIKE CONCAT('%', #{permissionName}, '%')
        </if>
        <if test="permissionCode != null and permissionCode != ''">
            AND permission_code LIKE CONCAT('%', #{permissionCode}, '%')
        </if>
        <if test="permissionType != null and permissionType != ''">
            AND permission_type = #{permissionType}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY sort_order ASC, create_time DESC
    </select>

    <!-- 查询权限树结构 -->
    <select id="selectPermissionTree" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM tsm_permission
        WHERE deleted = 0
        <if test="permissionType != null and permissionType != ''">
            AND permission_type = #{permissionType}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY sort_order ASC, create_time DESC
    </select>

    <!-- 查询子权限列表 -->
    <select id="selectChildrenPermissions" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM tsm_permission
        WHERE parent_id = #{parentId} AND deleted = 0
        ORDER BY sort_order ASC, create_time DESC
    </select>

    <!-- 根据角色ID查询权限列表 -->
    <select id="selectPermissionsByRoleId" resultMap="BaseResultMap">
        SELECT p.<include refid="Base_Column_List" />
        FROM tsm_permission p
        INNER JOIN tsm_role_permission rp ON p.id = rp.permission_id
        WHERE rp.role_id = #{roleId} AND p.deleted = 0
        ORDER BY p.sort_order ASC, p.create_time DESC
    </select>

    <!-- 根据用户ID查询权限列表 -->
    <select id="selectPermissionsByUserId" resultMap="BaseResultMap">
        SELECT DISTINCT p.<include refid="Base_Column_List" />
        FROM tsm_permission p
        INNER JOIN tsm_role_permission rp ON p.id = rp.permission_id
        INNER JOIN tsm_user_role ur ON rp.role_id = ur.role_id
        INNER JOIN tsm_role r ON ur.role_id = r.id
        WHERE ur.user_id = #{userId} AND p.deleted = 0 AND r.deleted = 0 AND r.status = 1
        ORDER BY p.sort_order ASC, p.create_time DESC
    </select>

    <!-- 检查权限编码是否存在 -->
    <select id="checkPermissionCodeExists" resultType="int">
        SELECT COUNT(1)
        FROM tsm_permission
        WHERE permission_code = #{permissionCode} AND deleted = 0
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 检查权限名称是否存在 -->
    <select id="checkPermissionNameExists" resultType="int">
        SELECT COUNT(1)
        FROM tsm_permission
        WHERE permission_name = #{permissionName} AND deleted = 0
        <if test="parentId != null">
            AND parent_id = #{parentId}
        </if>
        <if test="parentId == null">
            AND parent_id IS NULL
        </if>
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 批量删除权限 -->
    <update id="deleteBatchByIds">
        UPDATE tsm_permission SET deleted = 1
        WHERE id IN
        <foreach collection="permissionIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 更新权限状态 -->
    <update id="updateStatus">
        UPDATE tsm_permission 
        SET status = #{status}, update_time = NOW()
        WHERE id = #{permissionId} AND deleted = 0
    </update>

    <!-- 查询权限的所有子权限ID（递归） -->
    <select id="selectAllChildrenIds" resultType="java.lang.Long">
        SELECT id FROM tsm_permission WHERE parent_id = #{permissionId} AND deleted = 0
    </select>

    <!-- 检查是否有子权限 -->
    <select id="countChildrenPermissions" resultType="int">
        SELECT COUNT(1)
        FROM tsm_permission
        WHERE parent_id = #{permissionId} AND deleted = 0
    </select>

    <!-- 查询菜单权限列表（用于构建菜单树） -->
    <select id="selectMenuPermissions" resultMap="BaseResultMap">
        SELECT DISTINCT p.<include refid="Base_Column_List" />
        FROM tsm_permission p
        <if test="userId != null">
            INNER JOIN tsm_role_permission rp ON p.id = rp.permission_id
            INNER JOIN tsm_user_role ur ON rp.role_id = ur.role_id
            INNER JOIN tsm_role r ON ur.role_id = r.id
        </if>
        WHERE p.permission_type = 'MENU' AND p.deleted = 0 AND p.status = 1
        <if test="userId != null">
            AND ur.user_id = #{userId} AND r.deleted = 0 AND r.status = 1
        </if>
        ORDER BY p.sort_order ASC, p.create_time DESC
    </select>

    <!-- 查询按钮权限列表 -->
    <select id="selectButtonPermissions" resultMap="BaseResultMap">
        SELECT DISTINCT p.<include refid="Base_Column_List" />
        FROM tsm_permission p
        <if test="userId != null">
            INNER JOIN tsm_role_permission rp ON p.id = rp.permission_id
            INNER JOIN tsm_user_role ur ON rp.role_id = ur.role_id
            INNER JOIN tsm_role r ON ur.role_id = r.id
        </if>
        WHERE p.permission_type = 'BUTTON' AND p.deleted = 0 AND p.status = 1
        <if test="parentId != null">
            AND p.parent_id = #{parentId}
        </if>
        <if test="userId != null">
            AND ur.user_id = #{userId} AND r.deleted = 0 AND r.status = 1
        </if>
        ORDER BY p.sort_order ASC, p.create_time DESC
    </select>

</mapper>