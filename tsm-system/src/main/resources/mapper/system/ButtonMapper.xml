<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tsm.system.mapper.ButtonMapper">

    <!-- 按钮结果映射 -->
    <resultMap id="ButtonResult" type="com.tsm.system.entity.Button">
        <id property="id" column="id"/>
        <result property="permissionId" column="permission_id"/>
        <result property="buttonName" column="button_name"/>
        <result property="buttonCode" column="button_code"/>
        <result property="buttonIcon" column="button_icon"/>
        <result property="sort" column="sort"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="createBy" column="create_by"/>
        <result property="updateBy" column="update_by"/>
        <result property="delFlag" column="del_flag"/>
    </resultMap>

    <!-- 按钮及权限结果映射 -->
    <resultMap id="ButtonWithPermissionResult" type="com.tsm.system.entity.Button" extends="ButtonResult">
        <association property="permission" javaType="com.tsm.system.entity.Permission">
            <id property="id" column="p_id"/>
            <result property="permissionName" column="p_permission_name"/>
            <result property="permissionCode" column="p_permission_code"/>
            <result property="type" column="p_type"/>
            <result property="parentId" column="p_parent_id"/>
            <result property="path" column="p_path"/>
            <result property="component" column="p_component"/>
            <result property="icon" column="p_icon"/>
            <result property="sort" column="p_sort"/>
            <result property="status" column="p_status"/>
        </association>
    </resultMap>

    <!-- 基础字段 -->
    <sql id="selectButtonVo">
        select id, permission_id, button_name, button_code, button_icon, sort, status, 
               create_time, update_time, create_by, update_by, del_flag
        from sys_button
    </sql>

    <!-- 根据按钮编码查询按钮 -->
    <select id="selectButtonByCode" parameterType="String" resultMap="ButtonResult">
        <include refid="selectButtonVo"/>
        where button_code = #{buttonCode} and del_flag = 0
    </select>

    <!-- 分页查询按钮列表 -->
    <select id="selectButtonList" resultMap="ButtonResult">
        <include refid="selectButtonVo"/>
        <where>
            del_flag = 0
            <if test="buttonName != null and buttonName != ''">
                AND button_name like concat('%', #{buttonName}, '%')
            </if>
            <if test="buttonCode != null and buttonCode != ''">
                AND button_code like concat('%', #{buttonCode}, '%')
            </if>
            <if test="permissionId != null">
                AND permission_id = #{permissionId}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        order by sort asc, create_time asc
    </select>

    <!-- 查询按钮及其关联权限信息 -->
    <select id="selectButtonWithPermission" parameterType="Long" resultMap="ButtonWithPermissionResult">
        select b.id, b.permission_id, b.button_name, b.button_code, b.button_icon, b.sort, b.status,
               b.create_time, b.update_time, b.create_by, b.update_by, b.del_flag,
               p.id as p_id, p.permission_name as p_permission_name, p.permission_code as p_permission_code,
               p.type as p_type, p.parent_id as p_parent_id, p.path as p_path, p.component as p_component,
               p.icon as p_icon, p.sort as p_sort, p.status as p_status
        from sys_button b
        left join sys_permission p on b.permission_id = p.id
        where b.id = #{buttonId} and b.del_flag = 0
    </select>

    <!-- 根据权限ID查询按钮列表 -->
    <select id="selectButtonsByPermissionId" resultMap="ButtonResult">
        <include refid="selectButtonVo"/>
        <where>
            del_flag = 0
            AND permission_id = #{permissionId}
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        order by sort asc, create_time asc
    </select>

    <!-- 根据角色ID查询按钮列表 -->
    <select id="selectButtonsByRoleId" resultMap="ButtonResult">
        select distinct b.id, b.permission_id, b.button_name, b.button_code, b.button_icon, b.sort, b.status,
               b.create_time, b.update_time, b.create_by, b.update_by, b.del_flag
        from sys_button b
        inner join sys_role_button rb on b.id = rb.button_id
        <where>
            b.del_flag = 0
            AND rb.role_id = #{roleId}
            <if test="status != null">
                AND b.status = #{status}
            </if>
        </where>
        order by b.sort asc, b.create_time asc
    </select>

    <!-- 根据用户ID查询按钮列表 -->
    <select id="selectButtonsByUserId" resultMap="ButtonResult">
        select distinct b.id, b.permission_id, b.button_name, b.button_code, b.button_icon, b.sort, b.status,
               b.create_time, b.update_time, b.create_by, b.update_by, b.del_flag
        from sys_button b
        inner join sys_role_button rb on b.id = rb.button_id
        inner join sys_user_role ur on rb.role_id = ur.role_id
        <where>
            b.del_flag = 0
            AND ur.user_id = #{userId}
            <if test="status != null">
                AND b.status = #{status}
            </if>
        </where>
        order by b.sort asc, b.create_time asc
    </select>

    <!-- 检查按钮编码是否存在 -->
    <select id="checkButtonCodeExists" resultType="int">
        select count(1) from sys_button
        where button_code = #{buttonCode} and del_flag = 0
        <if test="excludeId != null">
            and id != #{excludeId}
        </if>
    </select>

    <!-- 检查按钮名称是否存在 -->
    <select id="checkButtonNameExists" resultType="int">
        select count(1) from sys_button
        where button_name = #{buttonName} and del_flag = 0
        <if test="excludeId != null">
            and id != #{excludeId}
        </if>
    </select>

    <!-- 批量删除按钮（逻辑删除） -->
    <update id="batchDeleteButtons">
        update sys_button set del_flag = 1, update_time = now()
        where id in
        <foreach collection="buttonIds" item="buttonId" open="(" separator="," close=")">
            #{buttonId}
        </foreach>
    </update>

    <!-- 更新按钮状态 -->
    <update id="updateButtonStatus">
        update sys_button set status = #{status}, update_time = now()
        where id = #{buttonId} and del_flag = 0
    </update>

    <!-- 根据权限ID列表查询按钮列表 -->
    <select id="selectButtonsByPermissionIds" resultMap="ButtonResult">
        <include refid="selectButtonVo"/>
        <where>
            del_flag = 0
            AND permission_id in
            <foreach collection="permissionIds" item="permissionId" open="(" separator="," close=")">
                #{permissionId}
            </foreach>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        order by sort asc, create_time asc
    </select>

    <!-- 查询所有可用按钮 -->
    <select id="selectAllAvailableButtons" resultMap="ButtonResult">
        <include refid="selectButtonVo"/>
        where del_flag = 0 and status = 1
        order by sort asc, create_time asc
    </select>

    <!-- 检查按钮是否被角色使用 -->
    <select id="checkButtonUsedByRole" resultType="int">
        select count(1) from sys_role_button where button_id = #{buttonId}
    </select>

</mapper>