<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tsm.system.mapper.UserMapper">

    <!-- 用户结果映射 -->
    <resultMap id="BaseResultMap" type="com.tsm.system.entity.User">
        <id column="id" property="id" />
        <result column="username" property="username" />
        <result column="password" property="password" />
        <result column="real_name" property="realName" />
        <result column="email" property="email" />
        <result column="phone" property="phone" />
        <result column="avatar" property="avatar" />
        <result column="status" property="status" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="create_by" property="createBy" />
        <result column="update_by" property="updateBy" />
        <result column="deleted" property="deleted" />
    </resultMap>

    <!-- 用户角色结果映射 -->
    <resultMap id="UserWithRolesResultMap" type="com.tsm.system.entity.User" extends="BaseResultMap">
        <collection property="roles" ofType="com.tsm.system.entity.Role">
            <id column="role_id" property="id" />
            <result column="role_name" property="roleName" />
            <result column="role_code" property="roleCode" />
            <result column="role_description" property="description" />
            <result column="role_status" property="status" />
        </collection>
    </resultMap>

    <!-- 基础字段 -->
    <sql id="Base_Column_List">
        id, username, password, real_name, email, phone, avatar, status, 
        create_time, update_time, create_by, update_by, deleted
    </sql>

    <!-- 根据用户名查询用户 -->
    <select id="selectByUsername" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM tsm_user
        WHERE username = #{username} AND deleted = 0
    </select>

    <!-- 分页查询用户列表 -->
    <select id="selectUserPage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM tsm_user
        WHERE deleted = 0
        <if test="username != null and username != ''">
            AND username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="realName != null and realName != ''">
            AND real_name LIKE CONCAT('%', #{realName}, '%')
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY create_time DESC
    </select>

    <!-- 查询用户及其角色信息 -->
    <select id="selectUserWithRoles" resultMap="UserWithRolesResultMap">
        SELECT 
            u.id, u.username, u.password, u.real_name, u.email, u.phone, u.avatar, u.status,
            u.create_time, u.update_time, u.create_by, u.update_by, u.deleted,
            r.id as role_id, r.role_name, r.role_code, r.description as role_description, r.status as role_status
        FROM tsm_user u
        LEFT JOIN tsm_user_role ur ON u.id = ur.user_id
        LEFT JOIN tsm_role r ON ur.role_id = r.id AND r.deleted = 0
        WHERE u.id = #{userId} AND u.deleted = 0
    </select>

    <!-- 根据角色ID查询用户列表 -->
    <select id="selectUsersByRoleId" resultMap="BaseResultMap">
        SELECT u.<include refid="Base_Column_List" />
        FROM tsm_user u
        INNER JOIN tsm_user_role ur ON u.id = ur.user_id
        WHERE ur.role_id = #{roleId} AND u.deleted = 0
        ORDER BY u.create_time DESC
    </select>

    <!-- 检查用户名是否存在 -->
    <select id="checkUsernameExists" resultType="int">
        SELECT COUNT(1)
        FROM tsm_user
        WHERE username = #{username} AND deleted = 0
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 检查邮箱是否存在 -->
    <select id="checkEmailExists" resultType="int">
        SELECT COUNT(1)
        FROM tsm_user
        WHERE email = #{email} AND deleted = 0
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 检查手机号是否存在 -->
    <select id="checkPhoneExists" resultType="int">
        SELECT COUNT(1)
        FROM tsm_user
        WHERE phone = #{phone} AND deleted = 0
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 批量删除用户 -->
    <update id="deleteBatchByIds">
        UPDATE tsm_user SET deleted = 1
        WHERE id IN
        <foreach collection="userIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 重置用户密码 -->
    <update id="resetPassword">
        UPDATE tsm_user 
        SET password = #{newPassword}, update_time = NOW()
        WHERE id = #{userId} AND deleted = 0
    </update>

    <!-- 更新用户状态 -->
    <update id="updateStatus">
        UPDATE tsm_user 
        SET status = #{status}, update_time = NOW()
        WHERE id = #{userId} AND deleted = 0
    </update>

</mapper>