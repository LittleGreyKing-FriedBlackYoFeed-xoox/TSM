<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSM</title>
    <link rel="stylesheet" href="/layui/css/layui.css">
    <style>
        /* 灰白色系主题变量 */
        :root {
            --primary-color: #6c757d;
            --secondary-color: #f8f9fa;
            --accent-color: #495057;
            --light-gray: #e9ecef;
            --dark-gray: #343a40;
            --white: #ffffff;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }

        body {
            background-color: var(--secondary-color);
            font-family: 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
        }

        .layui-layout-body {
            background-color: var(--secondary-color);
        }

        /* 强制覆盖Layui默认样式 */
        .layui-layout-admin .layui-header {
            background: linear-gradient(135deg, var(--white) 0%, var(--secondary-color) 100%) !important;
            border-bottom: 1px solid var(--border-color) !important;
        }

        .layui-layout-admin .layui-side {
            background: linear-gradient(180deg, var(--white) 0%, var(--secondary-color) 100%) !important;
            border-right: 1px solid var(--border-color) !important;
        }

        .layui-nav {
            background: transparent !important;
        }

        .layui-nav .layui-nav-item a {
            color: var(--accent-color) !important;
        }

        .layui-nav .layui-nav-item a:hover {
            background-color: var(--light-gray) !important;
            color: var(--dark-gray) !important;
        }

        .layui-nav .layui-this a {
            background-color: var(--primary-color) !important;
            color: var(--white) !important;
        }

        .layui-logo {
            color: var(--accent-color) !important;
        }

        /* 侧边栏导航项强制样式覆盖 */
        .layui-nav-tree {
            background: transparent !important;
        }

        .layui-nav-tree .layui-nav-item a {
            color: var(--accent-color) !important;
            background: transparent !important;
        }

        .layui-nav-tree .layui-nav-item a:hover {
            background-color: var(--light-gray) !important;
            color: var(--dark-gray) !important;
        }

        .layui-nav-tree .layui-this > a,
        .layui-nav-tree .layui-nav-item.layui-this > a {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%) !important;
            color: var(--white) !important;
        }

        /* 下拉菜单样式强制覆盖 */
        .layui-nav-tree .layui-nav-child {
            background: var(--secondary-color) !important;
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }

        .layui-nav-tree .layui-nav-child dd a {
            color: var(--primary-color) !important;
            background: transparent !important;
        }

        .layui-nav-tree .layui-nav-child dd a:hover {
            background-color: var(--light-gray) !important;
            color: var(--dark-gray) !important;
        }

        .layui-nav-tree .layui-nav-child dd.layui-this a {
            background: var(--primary-color) !important;
            color: var(--white) !important;
        }

        /* 确保展开的菜单项父级样式 */
        .layui-nav-tree .layui-nav-itemed > a {
            background-color: var(--light-gray) !important;
            color: var(--dark-gray) !important;
        }

        /* 侧边栏收缩状态样式 */
        .layui-side.collapsed {
            width: 60px !important;
        }

        .layui-side.collapsed .layui-nav-tree .layui-nav-item a {
            text-align: center !important;
            padding: 15px 5px !important;
        }

        .layui-side.collapsed .layui-nav-tree .layui-nav-item a span {
            display: none !important;
        }

        .layui-side.collapsed .layui-nav-tree .layui-nav-child {
            display: none !important;
        }

        /* 折叠按钮样式 */
        .sidebar-toggle {
            position: absolute;
            top: 10px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sidebar-toggle:hover {
            background: var(--light-gray);
        }

        .sidebar-toggle i {
            font-size: 14px;
            color: var(--primary-color);
        }

        /* 主体内容样式 */
        .content-body {
            padding: 20px;
            background-color: var(--secondary-color);
            min-height: calc(100vh - 120px);
        }

        /* 欢迎面板样式 */
        .welcome-panel {
            background: var(--white);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .welcome-panel h2 {
            color: var(--dark-gray);
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 10px;
        }

        .welcome-panel p {
            color: var(--primary-color);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .welcome-panel ul {
            color: var(--accent-color);
            line-height: 1.8;
        }

        .welcome-panel li {
            margin-bottom: 8px;
            position: relative;
            padding-left: 20px;
        }

        .welcome-panel li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--success-color);
            font-weight: bold;
        }

        /* 按钮演示面板样式 */
        .button-demo {
            background: var(--white);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .button-demo h3 {
            margin-bottom: 20px;
            color: var(--dark-gray);
            font-weight: 600;
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 10px;
        }

        .button-demo p {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        /* 按钮容器样式 */
        #buttonContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 20px;
            background: var(--secondary-color);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        /* 自定义按钮样式 */
        .demo-button {
            padding: 10px 20px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--white);
            color: var(--accent-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
        }

        .demo-button:hover {
            background: var(--light-gray);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .demo-button.btn-primary {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        .demo-button.btn-success {
            background: var(--success-color);
            color: var(--white);
            border-color: var(--success-color);
        }

        .demo-button.btn-warning {
            background: var(--warning-color);
            color: var(--dark-gray);
            border-color: var(--warning-color);
        }

        .demo-button.btn-danger {
            background: var(--danger-color);
            color: var(--white);
            border-color: var(--danger-color);
        }

        /* 统计卡片样式 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card .icon {
            font-size: 36px;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .stat-card .number {
            font-size: 28px;
            font-weight: bold;
            color: var(--dark-gray);
            margin-bottom: 8px;
        }

        .stat-card .label {
            color: var(--primary-color);
            font-size: 14px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .content-body {
                padding: 15px;
            }
            
            .welcome-panel, .button-demo {
                padding: 20px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            #buttonContainer {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="layui-layout-body">
    <div class="layui-layout layui-layout-admin">
        <!-- 引入头部片段 -->
        <div th:replace="fragments/header :: header"></div>
        
        <!-- 引入面包屑导航 -->
        <div th:replace="fragments/header :: breadcrumb"></div>
        
        <!-- 引入侧边栏片段 -->
        <div th:replace="fragments/sidebar :: sidebar"></div>
        
        <!-- 主体内容 -->
        <div class="layui-body">
            <div class="content-body" id="content">
                <!-- 统计卡片 -->
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="icon">
                            <i class="layui-icon layui-icon-user"></i>
                        </div>
                        <div class="number" id="userCount">--</div>
                        <div class="label">用户总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">
                            <i class="layui-icon layui-icon-group"></i>
                        </div>
                        <div class="number" id="roleCount">--</div>
                        <div class="label">角色总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">
                            <i class="layui-icon layui-icon-set"></i>
                        </div>
                        <div class="number" id="permissionCount">--</div>
                        <div class="label">权限总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">
                            <i class="layui-icon layui-icon-component"></i>
                        </div>
                        <div class="number" id="buttonCount">--</div>
                        <div class="label">按钮总数</div>
                    </div>
                </div>
                
                <!-- 欢迎面板 -->
                <div class="welcome-panel">
                    <h2>
                        <i class="layui-icon layui-icon-home" style="margin-right: 10px;"></i>
                        欢迎使用TSM
                    </h2>
                    <p>这是一个基于Spring Boot + Layui的分布式后台管理系统，支持按钮级权限管理。</p>
                    <p><strong>系统特性：</strong></p>
                    <ul>
                        <li>RBAC权限模型，支持用户、角色、权限三级管理</li>
                        <li>按钮级权限控制，可精确控制每个用户对每个按钮的操作权限</li>
                        <li>分布式架构，支持微服务部署</li>
                        <li>现代化UI界面，基于Layui框架</li>
                        <li>灰白色系设计，简洁优雅的用户体验</li>
                    </ul>
                </div>
                
                <!-- 按钮权限演示 -->
                <div class="button-demo">
                    <h3>
                        <i class="layui-icon layui-icon-component" style="margin-right: 10px;"></i>
                        按钮权限演示
                    </h3>
                    <p>以下按钮会根据当前用户的权限动态显示：</p>
                    <div id="buttonContainer">
                        <!-- 按钮将通过JavaScript动态加载 -->
                        <div class="demo-button btn-primary">
                            <i class="layui-icon layui-icon-add-1"></i> 新增用户
                        </div>
                        <div class="demo-button btn-success">
                            <i class="layui-icon layui-icon-edit"></i> 编辑用户
                        </div>
                        <div class="demo-button btn-danger">
                            <i class="layui-icon layui-icon-delete"></i> 删除用户
                        </div>
                        <div class="demo-button">
                            <i class="layui-icon layui-icon-search"></i> 查看用户
                        </div>
                        <div class="demo-button btn-warning">
                            <i class="layui-icon layui-icon-export"></i> 导出数据
                        </div>
                        <div class="demo-button">
                            <i class="layui-icon layui-icon-upload"></i> 导入数据
                        </div>
                        <div class="demo-button">
                            <i class="layui-icon layui-icon-set-sm"></i> 权限分配
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 引入尾部片段 -->
        <div th:replace="fragments/footer :: footer"></div>
        
        <!-- 引入返回顶部按钮 -->
        <div th:replace="fragments/footer :: backToTop"></div>
    </div>

    <script src="/layui/layui.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/js/main.js"></script>

    <script th:inline="none">
        layui.use(['element', 'layer'], function(){
            var element = layui.element;
            var layer = layui.layer;
            
            // 检查登录状态
            checkLogin();
            
            // 加载用户信息
            loadUserInfo();
            
            // 加载按钮权限
            loadButtonPermissions();
            
            // 加载统计数据
            loadStatistics();
            
            // 恢复侧边栏状态
            var savedState = localStorage.getItem('sidebarCollapsed');
            if (savedState === 'true') {
                toggleSidebar();
            }
        });

        // 检查登录状态
        function checkLogin() {
            var token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }
        }

        // 加载用户信息
        function loadUserInfo() {
            var usernameElement = document.getElementById('username');
            
            // 首先尝试从localStorage获取用户信息
            var storedUser = localStorage.getItem('user');
            if (storedUser) {
                try {
                    var user = JSON.parse(storedUser);
                    if (user && (user.realName || user.username)) {
                        usernameElement.textContent = user.realName || user.username;
                        return;
                    }
                } catch (e) {
                    console.log('解析本地用户信息失败:', e);
                }
            }
            
            // 如果本地没有用户信息，则从API获取
            var token = localStorage.getItem('token');
            if (!token) {
                usernameElement.textContent = '用户';
                return;
            }
            
            fetch('/api/auth/userinfo', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result && result.code === 200) {
                    var user = null;
                    // 尝试多种可能的数据结构
                    if (result.data && result.data.user) {
                        user = result.data.user;
                    } else if (result.data && result.data.realName) {
                        user = result.data;
                    } else if (result.user) {
                        user = result.user;
                    }
                    
                    if (user && (user.realName || user.username)) {
                        usernameElement.textContent = user.realName || user.username;
                        // 保存到localStorage
                        localStorage.setItem('user', JSON.stringify(user));
                    } else {
                        usernameElement.textContent = '用户';
                    }
                } else {
                    usernameElement.textContent = '用户';
                }
            })
            .catch(error => {
                console.log('获取用户信息失败:', error);
                usernameElement.textContent = '用户';
            });
        }

        // 加载统计数据
        function loadStatistics() {
            var token = localStorage.getItem('token');
            if (!token) return;
            
            fetch('/api/dashboard/statistics', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result && result.code === 200) {
                    updateStatistics(result.data);
                } else {
                    // 显示默认数据
                    updateStatistics({
                        userCount: 0,
                        roleCount: 0,
                        permissionCount: 0,
                        buttonCount: 0
                    });
                }
            })
            .catch(error => {
                console.log('获取统计数据失败:', error);
                // 显示默认数据
                updateStatistics({
                    userCount: 0,
                    roleCount: 0,
                    permissionCount: 0,
                    buttonCount: 0
                });
            });
        }

        // 更新统计数据显示
        function updateStatistics(data) {
            document.getElementById('userCount').textContent = data.userCount || 0;
            document.getElementById('roleCount').textContent = data.roleCount || 0;
            document.getElementById('permissionCount').textContent = data.permissionCount || 0;
            document.getElementById('buttonCount').textContent = data.buttonCount || 0;
        }

        // 加载按钮权限
        function loadButtonPermissions() {
            var token = localStorage.getItem('token');
            fetch('/api/auth/user-buttons/dashboard', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.code === 200) {
                    renderButtons(result.data);
                } else {
                    console.log('获取按钮权限失败:', result.message);
                    // 显示默认按钮
                    renderDefaultButtons();
                }
            })
            .catch(error => {
                console.error('获取按钮权限错误:', error);
                // 显示默认按钮
                renderDefaultButtons();
            });
        }

        // 渲染默认按钮
        function renderDefaultButtons() {
            var container = document.getElementById('buttonContainer');
            container.innerHTML = `
                <div class="demo-button btn-primary">
                    <i class="layui-icon layui-icon-add-1"></i> 新增用户
                </div>
                <div class="demo-button btn-success">
                    <i class="layui-icon layui-icon-edit"></i> 编辑用户
                </div>
                <div class="demo-button btn-danger">
                    <i class="layui-icon layui-icon-delete"></i> 删除用户
                </div>
                <div class="demo-button">
                    <i class="layui-icon layui-icon-search"></i> 查看用户
                </div>
                <div class="demo-button btn-warning">
                    <i class="layui-icon layui-icon-export"></i> 导出数据
                </div>
                <div class="demo-button">
                    <i class="layui-icon layui-icon-upload"></i> 导入数据
                </div>
                <div class="demo-button">
                    <i class="layui-icon layui-icon-set-sm"></i> 权限分配
                </div>
            `;
        }

        // 渲染按钮
        function renderButtons(buttons) {
            var container = document.getElementById('buttonContainer');
            var html = '';
            
            if (buttons && buttons.length > 0) {
                buttons.forEach(function(button) {
                    var btnClass = 'demo-button';
                    switch(button.buttonType) {
                        case 1: btnClass += ' btn-primary'; break; // 新增
                        case 2: btnClass += ' btn-success'; break;   // 编辑
                        case 3: btnClass += ' btn-danger'; break; // 删除
                        case 4: btnClass += ''; break;                  // 查看
                        case 5: btnClass += ' btn-warning'; break; // 导出
                        case 6: btnClass += ''; break; // 导入
                        default: btnClass += ''; break;
                    }
                    
                    html += '<div class="' + btnClass + '" onclick="handleButtonClick(\'' + 
                            button.buttonCode + '\')">' + 
                            (button.icon ? '<i class="layui-icon ' + button.icon + '"></i> ' : '') + 
                            button.buttonName + '</div>';
                });
            } else {
                html = '<p style="color: #999; text-align: center; padding: 20px;">当前用户没有任何按钮权限</p>';
            }
            
            container.innerHTML = html;
        }

        // 处理按钮点击
        function handleButtonClick(buttonCode) {
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg('点击了按钮: ' + buttonCode, {icon: 1});
            });
        }

        // 加载内容
        function loadContent(page) {
            // 这里可以实现页面切换逻辑
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg('加载页面: ' + page, {icon: 1});
            });
        }

        // 显示用户信息
        function showUserInfo() {
            layui.use('layer', function(){
                var layer = layui.layer;
                var user = JSON.parse(localStorage.getItem('user') || '{}');
                layer.open({
                    type: 1,
                    title: '个人信息',
                    content: '<div style="padding: 20px;">' +
                            '<p><strong>用户名：</strong>' + (user.username || '未知') + '</p>' +
                            '<p><strong>真实姓名：</strong>' + (user.realName || '未知') + '</p>' +
                            '<p><strong>邮箱：</strong>' + (user.email || '未设置') + '</p>' +
                            '<p><strong>手机：</strong>' + (user.phone || '未设置') + '</p>' +
                            '<p><strong>最后登录：</strong>' + new Date().toLocaleString() + '</p>' +
                            '</div>',
                    area: ['400px', '350px']
                });
            });
        }

        // 退出登录
        function logout() {
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.confirm('确定要退出登录吗？', {
                    icon: 3, 
                    title:'确认退出'
                }, function(index){
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    layer.msg('退出成功', {icon: 1}, function(){
                        window.location.href = '/login';
                    });
                    layer.close(index);
                });
            });
        }

        // 侧边栏收缩功能
        var sidebarCollapsed = false;
        
        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            var toggleIcon = document.getElementById('toggleIcon');
            var mainContent = document.querySelector('.main-content');
            
            if (sidebarCollapsed) {
                // 展开侧边栏
                sidebar.classList.remove('collapsed');
                toggleIcon.className = 'layui-icon layui-icon-shrink-right';
                if (mainContent) {
                    mainContent.classList.remove('collapsed');
                }
                sidebarCollapsed = false;
            } else {
                // 收起侧边栏
                sidebar.classList.add('collapsed');
                toggleIcon.className = 'layui-icon layui-icon-spread-left';
                if (mainContent) {
                    mainContent.classList.add('collapsed');
                }
                sidebarCollapsed = true;
            }
            
            // 保存状态到localStorage
            localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
        }

        // 导航点击处理
        function loadContent(page, title) {
            // 更新面包屑
            if (typeof updateBreadcrumb === 'function') {
                updateBreadcrumb(title, page);
            }
            
            // 更新导航状态
            updateNavState(page);
            
            // 加载内容
            layui.use('layer', function(){
                var layer = layui.layer;
                layer.msg('加载页面: ' + (title || page), {icon: 1});
            });
        }
        
        // 更新导航状态
        function updateNavState(page) {
            // 移除所有当前状态
            var navItems = document.querySelectorAll('.layui-nav-tree .layui-nav-item');
            navItems.forEach(function(item) {
                item.classList.remove('layui-this');
            });
            
            var childItems = document.querySelectorAll('.layui-nav-tree .layui-nav-child dd');
            childItems.forEach(function(item) {
                item.classList.remove('layui-this');
            });
            
            // 根据页面设置当前状态
            var targetElement = document.querySelector('[onclick*="' + page + '"]');
            if (targetElement) {
                var parentLi = targetElement.closest('.layui-nav-item');
                var parentDd = targetElement.closest('dd');
                
                if (parentDd) {
                    // 子菜单项
                    parentDd.classList.add('layui-this');
                    parentLi.classList.add('layui-nav-itemed');
                } else {
                    // 主菜单项
                    parentLi.classList.add('layui-this');
                }
            }
        }
    </script>
</body>
</html>