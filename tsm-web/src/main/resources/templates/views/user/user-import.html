<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户数据导入 - TSM系统</title>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>
    <div class="layui-container" style="padding: 20px;">
        <div class="layui-card">
            <div class="layui-card-header">
                <h3>用户数据导入</h3>
            </div>
            <div class="layui-card-body">
                <div class="layui-upload">
                    <button type="button" class="layui-btn" id="uploadBtn">选择文件</button>
                    <div class="layui-upload-list">
                        <table class="layui-table">
                            <thead>
                                <tr><th>文件名</th><th>大小</th><th>状态</th></tr>
                            </thead>
                            <tbody id="uploadList"></tbody>
                        </table>
                    </div>
                    <button type="button" class="layui-btn" id="uploadAllBtn">开始上传</button>
                </div>
                
                <div class="layui-form-item" style="margin-top: 20px;">
                    <div class="layui-input-block">
                        <button type="button" class="layui-btn layui-btn-primary" onclick="parent.layer.closeAll()">关闭</button>
                    </div>
                </div>
                
                <div class="layui-collapse" style="margin-top: 20px;">
                    <div class="layui-colla-item">
                        <h2 class="layui-colla-title">导入说明</h2>
                        <div class="layui-colla-content">
                            <p>1. 支持Excel文件格式（.xlsx, .xls）</p>
                            <p>2. 文件大小不超过10MB</p>
                            <p>3. Excel表格应包含以下列：用户名、真实姓名、邮箱、手机号</p>
                            <p>4. 用户名和邮箱不能重复</p>
                            <p>5. <a href="/template/user-import-template.xlsx" class="layui-btn layui-btn-xs">下载模板文件</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/layui/layui.js}"></script>
    <script>
        layui.use(['upload', 'element', 'layer'], function(){
            var upload = layui.upload;
            var element = layui.element;
            var layer = layui.layer;
            
            var uploadListIns = upload.render({
                elem: '#uploadBtn',
                url: '/api/user/import',
                accept: 'file',
                exts: 'xlsx|xls',
                auto: false,
                bindAction: '#uploadAllBtn',
                choose: function(obj){
                    var files = this.files = obj.pushFile();
                    obj.preview(function(index, file, result){
                        var tr = $(['<tr id="upload-'+ index +'">',
                            '<td>'+ file.name +'</td>',
                            '<td>'+ (file.size/1014).toFixed(1) +'kb</td>',
                            '<td>等待上传</td>',
                        '</tr>'].join(''));
                        $('#uploadList').append(tr);
                    });
                },
                done: function(res, index, upload){
                    if(res.code == 0){
                        $('#upload-'+ index).find('td').eq(2).html('<span style="color: #5FB878;">上传成功</span>');
                        layer.msg('导入成功：' + res.data.successCount + '条记录');
                    } else {
                        $('#upload-'+ index).find('td').eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                        layer.msg('导入失败：' + res.msg);
                    }
                },
                error: function(index, upload){
                    $('#upload-'+ index).find('td').eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                    layer.msg('上传失败');
                }
            });
        });
    </script>
</body>
</html>