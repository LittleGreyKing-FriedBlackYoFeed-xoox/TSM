<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添加用户 - TSM</title>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <style>
        /* 使用全局CSS变量 */
        :root {
            --primary-color: #6c757d;
            --secondary-color: #f8f9fa;
            --accent-color: #495057;
            --light-gray: #e9ecef;
            --dark-gray: #343a40;
            --white: #ffffff;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }

        .add-user-container {
            padding: 24px;
            background: transparent;
        }
        
        .form-container {
            background: var(--white);
            padding: 32px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 24px;
            text-align: center;
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 16px;
        }
        
        .layui-form-label {
            color: var(--accent-color);
            font-weight: 500;
            width: 120px;
        }
        
        .layui-input, .layui-select, .layui-textarea {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: border-color 0.3s ease;
        }
        
        .layui-input:focus, .layui-select:focus, .layui-textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(108, 117, 125, 0.2);
        }
        
        .layui-btn {
            border-radius: 4px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .layui-btn-normal {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .layui-btn-normal:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .form-actions {
            text-align: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--light-gray);
        }
        
        .form-actions .layui-btn {
            margin: 0 8px;
            min-width: 100px;
        }
        
        .required {
            color: var(--danger-color);
        }
        
        .form-tips {
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 24px;
            color: var(--accent-color);
        }
        
        .form-tips h4 {
            margin: 0 0 8px 0;
            color: var(--primary-color);
        }
        
        .form-tips ul {
            margin: 8px 0 0 20px;
            padding: 0;
        }
        
        .form-tips li {
            margin-bottom: 4px;
        }
    </style>
</head>
<body class="layui-layout-body">
    <div class="layui-layout layui-layout-admin">
        <!-- 引入头部片段 -->
        <div th:replace="~{fragments/header :: header}"></div>

        <!-- 主要内容区域 -->
        <div class="main-content">
            <div class="add-user-container">
                <div class="form-container">
                    <h2 class="form-title">
                        <i class="layui-icon layui-icon-add-1" style="margin-right: 8px;"></i>
                        添加用户
                    </h2>
                    
                    <div class="form-tips">
                        <h4><i class="layui-icon layui-icon-tips" style="margin-right: 4px;"></i>填写说明</h4>
                        <ul>
                            <li>用户名必须唯一，建议使用英文字母和数字组合</li>
                            <li>密码长度至少6位，建议包含字母和数字</li>
                            <li>邮箱格式必须正确，用于系统通知</li>
                            <li>手机号用于重要操作验证</li>
                        </ul>
                    </div>
                    
                    <form class="layui-form" lay-filter="addUserForm">
                        <div class="layui-row layui-col-space16">
                            <div class="layui-col-md6">
                                <div class="layui-form-item">
                                    <label class="layui-form-label"><span class="required">*</span>用户名</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="username" required lay-verify="required" 
                                               placeholder="请输入用户名" class="layui-input" autocomplete="off">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md6">
                                <div class="layui-form-item">
                                    <label class="layui-form-label"><span class="required">*</span>真实姓名</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="realName" required lay-verify="required" 
                                               placeholder="请输入真实姓名" class="layui-input">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="layui-row layui-col-space16">
                            <div class="layui-col-md6">
                                <div class="layui-form-item">
                                    <label class="layui-form-label"><span class="required">*</span>密码</label>
                                    <div class="layui-input-block">
                                        <input type="password" name="password" required lay-verify="required" 
                                               placeholder="请输入密码" class="layui-input" autocomplete="new-password">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md6">
                                <div class="layui-form-item">
                                    <label class="layui-form-label"><span class="required">*</span>确认密码</label>
                                    <div class="layui-input-block">
                                        <input type="password" name="confirmPassword" required lay-verify="required" 
                                               placeholder="请再次输入密码" class="layui-input" autocomplete="new-password">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="layui-row layui-col-space16">
                            <div class="layui-col-md6">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">邮箱</label>
                                    <div class="layui-input-block">
                                        <input type="email" name="email" lay-verify="email" 
                                               placeholder="请输入邮箱地址" class="layui-input">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md6">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">手机号</label>
                                    <div class="layui-input-block">
                                        <input type="tel" name="phone" lay-verify="phone" 
                                               placeholder="请输入手机号" class="layui-input">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="layui-row layui-col-space16">
                            <div class="layui-col-md6">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">状态</label>
                                    <div class="layui-input-block">
                                        <select name="status" lay-verify="">
                                            <option value="0" selected>正常</option>
                                            <option value="1">禁用</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-md6">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">角色</label>
                                    <div class="layui-input-block">
                                        <select name="roleId" lay-verify="">
                                            <option value="">请选择角色</option>
                                            <option value="1">管理员</option>
                                            <option value="2">普通用户</option>
                                            <option value="3">访客</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="layui-form-item">
                            <label class="layui-form-label">备注</label>
                            <div class="layui-input-block">
                                <textarea name="remark" placeholder="请输入备注信息" 
                                          class="layui-textarea" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="submitUser">
                                <i class="layui-icon layui-icon-ok"></i> 保存用户
                            </button>
                            <button type="reset" class="layui-btn layui-btn-primary">
                                <i class="layui-icon layui-icon-refresh"></i> 重置
                            </button>
                            <button type="button" class="layui-btn layui-btn-warm" onclick="goBack()">
                                <i class="layui-icon layui-icon-return"></i> 返回
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 引入尾部片段 -->
        <div th:replace="~{fragments/footer :: footer}"></div>
        <div th:replace="~{fragments/footer :: backToTop}"></div>
    </div>

    <script th:src="@{/layui/layui.js}"></script>
    <script th:inline="none">
        layui.use(['form', 'layer'], function(){
            var form = layui.form;
            var layer = layui.layer;
            
            // 自定义验证规则
            form.verify({
                confirmPassword: function(value, item) {
                    var password = document.querySelector('input[name="password"]').value;
                    if (value !== password) {
                        return '两次密码输入不一致';
                    }
                }
            });
            
            // 表单提交
            form.on('submit(submitUser)', function(data){
                var formData = data.field;
                
                // 验证必填字段
                if (!formData.username || !formData.realName || !formData.password) {
                    layer.msg('请填写必填字段');
                    return false;
                }
                
                // 验证密码一致性
                if (formData.password !== formData.confirmPassword) {
                    layer.msg('两次密码输入不一致');
                    return false;
                }
                
                // 移除确认密码字段
                delete formData.confirmPassword;
                
                // 显示加载层
                var loadIndex = layer.load(2, {shade: [0.3, '#000']});
                
                // 发送请求
                fetch('/api/user/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(result => {
                    layer.close(loadIndex);
                    if (result.code === 0 || result.code === 200) {
                        layer.msg('用户添加成功', {icon: 1}, function(){
                            // 跳转到用户管理页面
                            window.location.href = '/user-management';
                        });
                    } else {
                        layer.msg(result.msg || '添加失败', {icon: 2});
                    }
                })
                .catch(error => {
                    layer.close(loadIndex);
                    console.error('Error:', error);
                    layer.msg('网络错误，请稍后重试', {icon: 2});
                });
                
                return false; // 阻止表单跳转
            });
        });
        
        // 返回上一页
        function goBack() {
            history.back();
        }
    </script>
</body>
</html>