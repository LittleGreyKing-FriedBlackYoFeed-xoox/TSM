<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSM</title>
    <link rel="stylesheet" th:href="@{/static/layui/css/layui.css}">
    <style>
        /* 灰白色系主题样式 */
        :root {
            --primary-color: #6c757d;
            --secondary-color: #f8f9fa;
            --accent-color: #495057;
            --light-gray: #e9ecef;
            --dark-gray: #343a40;
            --white: #ffffff;
            --border-color: #dee2e6;
        }

        .layui-layout-admin .layui-header {
            background: linear-gradient(135deg, var(--dark-gray) 0%, var(--primary-color) 100%);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .layui-logo {
            color: var(--white) !important;
            font-weight: 600 !important;
            font-size: 18px !important;
            letter-spacing: 1px;
        }

        .layui-nav .layui-nav-item a {
            color: var(--white) !important;
            transition: all 0.3s ease;
        }

        .layui-nav .layui-nav-item a:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }

        .layui-nav-img {
            border-radius: 50%;
            border: 2px solid var(--white);
        }

        /* 面包屑导航样式 */
        .breadcrumb-container {
            background: var(--white);
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .layui-breadcrumb {
            font-size: 14px;
        }

        .layui-breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .layui-breadcrumb a:hover {
            color: var(--accent-color);
        }

        .layui-breadcrumb span {
            color: var(--accent-color);
            font-weight: 500;
        }

        /* 用户下拉菜单样式 */
        .layui-nav-child {
            background: var(--white) !important;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .layui-nav-child dd a {
            color: var(--accent-color) !important;
            padding: 10px 20px;
        }

        .layui-nav-child dd a:hover {
            background-color: var(--light-gray) !important;
        }
    </style>
</head>

<!-- 头部片段 -->
<div th:fragment="header" class="layui-header">
    <div class="layui-logo">
        <i class="layui-icon layui-icon-home" style="margin-right: 8px;"></i>
        TSM
    </div>
    <ul class="layui-nav layui-layout-right">
        <li class="layui-nav-item">
            <a href="javascript:;">
                <img th:src="@{/static/img/favicon.ico}" class="layui-nav-img" style="width: 30px; height: 30px;">
                <span id="username">用户</span>
            </a>
            <dl class="layui-nav-child">
                <dd><a href="javascript:;" onclick="showUserInfo()">
                    <i class="layui-icon layui-icon-user"></i> 个人信息
                </a></dd>
                <dd><a href="javascript:;" onclick="changePassword()">
                    <i class="layui-icon layui-icon-password"></i> 修改密码
                </a></dd>
                <dd><a href="javascript:;" onclick="logout()">
                    <i class="layui-icon layui-icon-logout"></i> 退出登录
                </a></dd>
            </dl>
        </li>
    </ul>
</div>

<!-- 面包屑导航片段 -->
<div th:fragment="breadcrumb" class="breadcrumb-container">
    <span class="layui-breadcrumb" lay-separator=">" id="breadcrumb">
        <a href="javascript:;" onclick="loadContent('dashboard')">首页</a>
        <span id="currentPage">仪表板</span>
    </span>
</div>

<script>
    // 面包屑导航管理
    var breadcrumbManager = {
        history: [{ name: '首页', page: 'dashboard' }],
        
        // 添加面包屑
        add: function(name, page) {
            // 检查是否已存在
            var existIndex = this.history.findIndex(item => item.page === page);
            if (existIndex !== -1) {
                // 如果存在，截取到该位置
                this.history = this.history.slice(0, existIndex + 1);
            } else {
                // 如果不存在，添加新项
                this.history.push({ name: name, page: page });
            }
            this.render();
        },
        
        // 渲染面包屑
        render: function() {
            var breadcrumbEl = document.getElementById('breadcrumb');
            if (!breadcrumbEl) return;
            
            var html = '';
            for (var i = 0; i < this.history.length; i++) {
                var item = this.history[i];
                if (i === this.history.length - 1) {
                    // 最后一项不可点击
                    html += '<span>' + item.name + '</span>';
                } else {
                    html += '<a href="javascript:;" onclick="loadContent(\'' + item.page + '\')">' + item.name + '</a>';
                }
            }
            breadcrumbEl.innerHTML = html;
        },
        
        // 返回上一级
        back: function() {
            if (this.history.length > 1) {
                this.history.pop();
                var lastItem = this.history[this.history.length - 1];
                loadContent(lastItem.page);
                this.render();
            }
        }
    };

    // 全局函数：更新面包屑
    function updateBreadcrumb(name, page) {
        breadcrumbManager.add(name, page);
    }

    // 全局函数：返回上一级
    function goBack() {
        breadcrumbManager.back();
    }

    // 加载用户信息
    function loadUserInfo() {
        var usernameElement = document.getElementById('username');
        
        // 首先尝试从localStorage获取用户信息
        var storedUser = localStorage.getItem('user');
        if (storedUser) {
            try {
                var user = JSON.parse(storedUser);
                if (user && (user.realName || user.username)) {
                    usernameElement.textContent = user.realName || user.username;
                    return;
                }
            } catch (e) {
                console.log('解析本地用户信息失败:', e);
            }
        }
        
        // 如果本地没有用户信息，则从API获取
        var token = localStorage.getItem('token');
        if (!token) {
            usernameElement.textContent = '用户';
            return;
        }
        
        fetch('/tsm/api/auth/userinfo', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result && result.code === 200) {
                var user = null;
                if (result.data && result.data.user) {
                    user = result.data.user;
                } else if (result.data && result.data.realName) {
                    user = result.data;
                } else if (result.user) {
                    user = result.user;
                }
                
                if (user && (user.realName || user.username)) {
                    usernameElement.textContent = user.realName || user.username;
                    localStorage.setItem('user', JSON.stringify(user));
                } else {
                    usernameElement.textContent = '用户';
                }
            } else {
                usernameElement.textContent = '用户';
            }
        })
        .catch(error => {
            console.log('获取用户信息失败:', error);
            usernameElement.textContent = '用户';
        });
    }

    // 显示用户信息
    function showUserInfo() {
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.msg('个人信息功能开发中...', {icon: 6});
        });
    }

    // 修改密码
    function changePassword() {
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.msg('修改密码功能开发中...', {icon: 6});
        });
    }

    // 退出登录
    function logout() {
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.confirm('确定要退出登录吗？', {icon: 3, title:'提示'}, function(index){
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                layer.close(index);
                window.location.href = '/tsm/login';
            });
        });
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        loadUserInfo();
    });
</script>
</html>