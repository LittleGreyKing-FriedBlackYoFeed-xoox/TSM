<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色管理</title>
    <style>
        .search-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .table-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .role-info {
            display: flex;
            align-items: center;
        }
        
        .role-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            margin-right: 12px;
        }
        
        .role-icon.admin {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .role-icon.manager {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }
        
        .role-icon.user {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }
        
        .role-icon.default {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
        }
        
        .role-details {
            flex: 1;
        }
        
        .role-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        
        .role-code {
            font-size: 12px;
            color: #666;
        }
        
        .permission-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .permission-tag {
            display: inline-block;
            padding: 2px 8px;
            background: #e9ecef;
            color: #495057;
            border-radius: 12px;
            font-size: 11px;
        }
        
        .permission-tag.menu {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .permission-tag.button {
            background: #d4edda;
            color: #155724;
        }
        
        .user-count {
            text-align: center;
            font-weight: 600;
        }
        
        .user-count .count {
            font-size: 18px;
            color: #667eea;
        }
        
        .user-count .label {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- 搜索表单 -->
    <div class="search-form">
        <form class="layui-form" lay-filter="searchForm">
            <div class="layui-row">
                <div class="layui-col-md8">
                    <div class="layui-inline">
                        <label class="layui-form-label">角色名称：</label>
                        <div class="layui-input-inline">
                            <input type="text" name="roleName" placeholder="请输入角色名称" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">角色编码：</label>
                        <div class="layui-input-inline">
                            <input type="text" name="roleCode" placeholder="请输入角色编码" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">状态：</label>
                        <div class="layui-input-inline">
                            <select name="status">
                                <option value="">全部状态</option>
                                <option value="1">正常</option>
                                <option value="0">禁用</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md4">
                    <div class="layui-inline">
                        <button type="submit" class="layui-btn" lay-submit lay-filter="search">
                            <i class="layui-icon layui-icon-search"></i> 搜索
                        </button>
                        <button type="reset" class="layui-btn layui-btn-primary">
                            <i class="layui-icon layui-icon-refresh"></i> 重置
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <!-- 角色列表 -->
    <div class="table-container">
        <div class="table-header">
            <h3 class="table-title">角色列表</h3>
            <div class="table-actions">
                <button class="layui-btn layui-btn-sm" onclick="batchDelete()">
                    <i class="layui-icon layui-icon-delete"></i> 批量删除
                </button>
                <button class="layui-btn layui-btn-normal layui-btn-sm" onclick="addRole()">
                    <i class="layui-icon layui-icon-add-1"></i> 添加角色
                </button>
            </div>
        </div>
        
        <table class="layui-table" lay-filter="roleTable">
            <thead>
                <tr>
                    <th lay-data="{type:'checkbox', fixed:'left'}"></th>
                    <th lay-data="{field:'id', width:80, sort:true}">ID</th>
                    <th lay-data="{field:'roleInfo', width:200}">角色信息</th>
                    <th lay-data="{field:'description', width:200}">描述</th>
                    <th lay-data="{field:'permissions', width:250}">权限</th>
                    <th lay-data="{field:'userCount', width:100, align:'center'}">用户数</th>
                    <th lay-data="{field:'status', width:80, align:'center'}">状态</th>
                    <th lay-data="{field:'createTime', width:160}">创建时间</th>
                    <th lay-data="{field:'operate', width:250, fixed:'right', align:'center'}">操作</th>
                </tr>
            </thead>
            <tbody>
                <!-- 数据将通过JavaScript动态加载 -->
            </tbody>
        </table>
        
        <!-- 分页 -->
        <div id="pagination"></div>
    </div>
    
    <script>
        layui.use(['table', 'form', 'laypage', 'layer', 'tree'], function(){
            var table = layui.table;
            var form = layui.form;
            var laypage = layui.laypage;
            var layer = layui.layer;
            var tree = layui.tree;
            
            // 模拟角色数据
            var roleData = [
                {
                    id: 1,
                    roleName: '超级管理员',
                    roleCode: 'SUPER_ADMIN',
                    description: '系统超级管理员，拥有所有权限',
                    status: 1,
                    userCount: 1,
                    permissions: [
                        {name: '用户管理', type: 'menu'},
                        {name: '角色管理', type: 'menu'},
                        {name: '权限管理', type: 'menu'},
                        {name: '系统设置', type: 'menu'},
                        {name: '添加', type: 'button'},
                        {name: '编辑', type: 'button'},
                        {name: '删除', type: 'button'}
                    ],
                    createTime: '2024-01-01 09:00:00'
                },
                {
                    id: 2,
                    roleName: '部门经理',
                    roleCode: 'DEPT_MANAGER',
                    description: '部门经理，管理本部门用户和基础权限',
                    status: 1,
                    userCount: 5,
                    permissions: [
                        {name: '用户管理', type: 'menu'},
                        {name: '角色管理', type: 'menu'},
                        {name: '添加', type: 'button'},
                        {name: '编辑', type: 'button'}
                    ],
                    createTime: '2024-01-02 10:00:00'
                },
                {
                    id: 3,
                    roleName: '普通用户',
                    roleCode: 'NORMAL_USER',
                    description: '普通用户，只能查看基础信息',
                    status: 1,
                    userCount: 25,
                    permissions: [
                        {name: '个人中心', type: 'menu'},
                        {name: '查看', type: 'button'}
                    ],
                    createTime: '2024-01-03 11:00:00'
                },
                {
                    id: 4,
                    roleName: '访客',
                    roleCode: 'GUEST',
                    description: '访客角色，只读权限',
                    status: 0,
                    userCount: 0,
                    permissions: [
                        {name: '查看', type: 'button'}
                    ],
                    createTime: '2024-01-04 12:00:00'
                }
            ];
            
            // 渲染表格
            function renderTable(data = roleData) {
                var tableData = data.map(function(item) {
                    return {
                        id: item.id,
                        roleInfo: getRoleInfoHtml(item),
                        description: item.description,
                        permissions: getPermissionsHtml(item.permissions),
                        userCount: getUserCountHtml(item.userCount),
                        status: getStatusHtml(item.status),
                        createTime: item.createTime,
                        operate: getOperateHtml(item)
                    };
                });
                
                table.render({
                    elem: '.layui-table',
                    data: tableData,
                    page: false,
                    limit: 10,
                    cols: [[
                        {type:'checkbox', fixed:'left'},
                        {field:'id', title:'ID', width:80, sort:true},
                        {field:'roleInfo', title:'角色信息', width:200},
                        {field:'description', title:'描述', width:200},
                        {field:'permissions', title:'权限', width:250},
                        {field:'userCount', title:'用户数', width:100, align:'center'},
                        {field:'status', title:'状态', width:80, align:'center'},
                        {field:'createTime', title:'创建时间', width:160},
                        {field:'operate', title:'操作', width:250, fixed:'right', align:'center'}
                    ]]
                });
            }
            
            // 获取角色信息HTML
            function getRoleInfoHtml(role) {
                var iconClass = 'default';
                var iconText = 'R';
                
                if (role.roleCode.includes('ADMIN')) {
                    iconClass = 'admin';
                    iconText = 'A';
                } else if (role.roleCode.includes('MANAGER')) {
                    iconClass = 'manager';
                    iconText = 'M';
                } else if (role.roleCode.includes('USER')) {
                    iconClass = 'user';
                    iconText = 'U';
                }
                
                return `
                    <div class="role-info">
                        <div class="role-icon ${iconClass}">
                            <i class="layui-icon layui-icon-group"></i>
                        </div>
                        <div class="role-details">
                            <div class="role-name">${role.roleName}</div>
                            <div class="role-code">${role.roleCode}</div>
                        </div>
                    </div>
                `;
            }
            
            // 获取权限HTML
            function getPermissionsHtml(permissions) {
                if (!permissions || permissions.length === 0) {
                    return '<span style="color: #999;">暂无权限</span>';
                }
                
                var html = '<div class="permission-tags">';
                permissions.slice(0, 5).forEach(function(perm) {
                    html += `<span class="permission-tag ${perm.type}">${perm.name}</span>`;
                });
                
                if (permissions.length > 5) {
                    html += `<span class="permission-tag">+${permissions.length - 5}</span>`;
                }
                
                html += '</div>';
                return html;
            }
            
            // 获取用户数HTML
            function getUserCountHtml(count) {
                return `
                    <div class="user-count">
                        <div class="count">${count}</div>
                        <div class="label">用户</div>
                    </div>
                `;
            }
            
            // 获取状态HTML
            function getStatusHtml(status) {
                switch(status) {
                    case 1:
                        return '<span class="layui-badge layui-bg-green">正常</span>';
                    case 0:
                        return '<span class="layui-badge">禁用</span>';
                    default:
                        return '<span class="layui-badge layui-bg-gray">未知</span>';
                }
            }
            
            // 获取操作按钮HTML
            function getOperateHtml(role) {
                var canDelete = role.id !== 1; // 超级管理员不能删除
                
                return `
                    <button class="layui-btn layui-btn-xs" onclick="editRole(${role.id})">
                        <i class="layui-icon layui-icon-edit"></i> 编辑
                    </button>
                    <button class="layui-btn layui-btn-xs layui-btn-normal" onclick="assignPermissions(${role.id})">
                        <i class="layui-icon layui-icon-vercode"></i> 分配权限
                    </button>
                    <button class="layui-btn layui-btn-xs ${role.status === 1 ? 'layui-btn-warm' : 'layui-btn-normal'}" onclick="toggleStatus(${role.id}, ${role.status})">
                        <i class="layui-icon ${role.status === 1 ? 'layui-icon-pause' : 'layui-icon-play'}"></i> ${role.status === 1 ? '禁用' : '启用'}
                    </button>
                    ${canDelete ? `
                        <button class="layui-btn layui-btn-xs layui-btn-danger" onclick="deleteRole(${role.id})">
                            <i class="layui-icon layui-icon-delete"></i> 删除
                        </button>
                    ` : ''}
                `;
            }
            
            // 初始化表格
            renderTable();
            
            // 搜索表单提交
            form.on('submit(search)', function(data){
                var formData = data.field;
                var filteredData = roleData.filter(function(role) {
                    var match = true;
                    
                    if (formData.roleName && role.roleName.indexOf(formData.roleName) === -1) {
                        match = false;
                    }
                    
                    if (formData.roleCode && role.roleCode.indexOf(formData.roleCode) === -1) {
                        match = false;
                    }
                    
                    if (formData.status !== '' && role.status != formData.status) {
                        match = false;
                    }
                    
                    return match;
                });
                
                renderTable(filteredData);
                layer.msg('搜索完成，共找到 ' + filteredData.length + ' 条记录');
                return false;
            });
            
            // 全局函数
            window.addRole = function() {
                layer.open({
                    type: 2,
                    title: '添加角色',
                    area: ['600px', '500px'],
                    content: 'role-form.html',
                    btn: ['保存', '取消'],
                    yes: function(index, layero) {
                        var iframeWin = window[layero.find('iframe')[0]['name']];
                        iframeWin.submitForm(function(data) {
                            layer.msg('角色添加成功', {icon: 1});
                            layer.close(index);
                            renderTable();
                        });
                    }
                });
            };
            
            window.editRole = function(id) {
                var role = roleData.find(r => r.id === id);
                if (!role) {
                    layer.msg('角色不存在', {icon: 2});
                    return;
                }
                
                layer.open({
                    type: 2,
                    title: '编辑角色',
                    area: ['600px', '500px'],
                    content: 'role-form.html?id=' + id,
                    btn: ['保存', '取消'],
                    yes: function(index, layero) {
                        var iframeWin = window[layero.find('iframe')[0]['name']];
                        iframeWin.submitForm(function(data) {
                            layer.msg('角色更新成功', {icon: 1});
                            layer.close(index);
                            renderTable();
                        });
                    }
                });
            };
            
            window.assignPermissions = function(id) {
                var role = roleData.find(r => r.id === id);
                if (!role) {
                    layer.msg('角色不存在', {icon: 2});
                    return;
                }
                
                // 权限树数据
                var permissionTree = [
                    {
                        title: '系统管理',
                        id: 1,
                        spread: true,
                        children: [
                            {
                                title: '用户管理',
                                id: 11,
                                checked: true,
                                children: [
                                    {title: '查看用户', id: 111, checked: true},
                                    {title: '添加用户', id: 112, checked: true},
                                    {title: '编辑用户', id: 113, checked: true},
                                    {title: '删除用户', id: 114, checked: false}
                                ]
                            },
                            {
                                title: '角色管理',
                                id: 12,
                                checked: true,
                                children: [
                                    {title: '查看角色', id: 121, checked: true},
                                    {title: '添加角色', id: 122, checked: false},
                                    {title: '编辑角色', id: 123, checked: false},
                                    {title: '删除角色', id: 124, checked: false}
                                ]
                            },
                            {
                                title: '权限管理',
                                id: 13,
                                checked: false,
                                children: [
                                    {title: '查看权限', id: 131, checked: false},
                                    {title: '分配权限', id: 132, checked: false}
                                ]
                            }
                        ]
                    },
                    {
                        title: '业务管理',
                        id: 2,
                        spread: false,
                        children: [
                            {
                                title: '订单管理',
                                id: 21,
                                checked: false,
                                children: [
                                    {title: '查看订单', id: 211, checked: false},
                                    {title: '处理订单', id: 212, checked: false}
                                ]
                            }
                        ]
                    }
                ];
                
                layer.open({
                    type: 1,
                    title: '分配权限 - ' + role.roleName,
                    area: ['500px', '600px'],
                    content: `
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 15px; color: #666;">
                                请选择要分配给角色 <strong>${role.roleName}</strong> 的权限：
                            </div>
                            <div id="permissionTree" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; padding: 10px;"></div>
                        </div>
                    `,
                    btn: ['保存', '取消'],
                    success: function(layero, index) {
                        tree.render({
                            elem: '#permissionTree',
                            data: permissionTree,
                            showCheckbox: true,
                            id: 'permissionTreeId'
                        });
                    },
                    yes: function(index) {
                        var checkedData = tree.getChecked('permissionTreeId');
                        console.log('选中的权限：', checkedData);
                        layer.msg('权限分配成功', {icon: 1});
                        layer.close(index);
                        renderTable();
                    }
                });
            };
            
            window.toggleStatus = function(id, currentStatus) {
                if (id === 1) {
                    layer.msg('超级管理员角色不能禁用', {icon: 2});
                    return;
                }
                
                var newStatus = currentStatus === 1 ? 0 : 1;
                var statusText = newStatus === 1 ? '启用' : '禁用';
                
                layer.confirm('确定要' + statusText + '该角色吗？', {
                    icon: 3,
                    title: '提示'
                }, function(index) {
                    var role = roleData.find(r => r.id === id);
                    if (role) {
                        role.status = newStatus;
                    }
                    
                    layer.msg(statusText + '成功', {icon: 1});
                    layer.close(index);
                    renderTable();
                });
            };
            
            window.deleteRole = function(id) {
                if (id === 1) {
                    layer.msg('超级管理员角色不能删除', {icon: 2});
                    return;
                }
                
                var role = roleData.find(r => r.id === id);
                if (role && role.userCount > 0) {
                    layer.msg('该角色下还有用户，不能删除', {icon: 2});
                    return;
                }
                
                layer.confirm('确定要删除该角色吗？删除后不可恢复！', {
                    icon: 3,
                    title: '警告'
                }, function(index) {
                    roleData = roleData.filter(r => r.id !== id);
                    
                    layer.msg('删除成功', {icon: 1});
                    layer.close(index);
                    renderTable();
                });
            };
            
            window.batchDelete = function() {
                var checkStatus = table.checkStatus('roleTable');
                if (checkStatus.data.length === 0) {
                    layer.msg('请选择要删除的角色', {icon: 2});
                    return;
                }
                
                // 检查是否包含超级管理员
                var hasAdmin = checkStatus.data.some(item => item.id === 1);
                if (hasAdmin) {
                    layer.msg('不能删除超级管理员角色', {icon: 2});
                    return;
                }
                
                layer.confirm('确定要删除选中的 ' + checkStatus.data.length + ' 个角色吗？', {
                    icon: 3,
                    title: '批量删除'
                }, function(index) {
                    layer.msg('批量删除成功', {icon: 1});
                    layer.close(index);
                    renderTable();
                });
            };
        });
    </script>
</body>
</html>